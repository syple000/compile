DECLS

%% 
#include "../../doc/attribute.h"

static SymbolTableManager tableManager(1000);
%%

1 DECLS DECL sm DECLS;
2 DECLS null;

3 DECL QLFR TYPE PTR id 
    "action_1=
        CfInfo::MoveAttributes($-2, $-1);" 
    ARR 
    "reduction_action= 
        CfInfo::MoveAttributes($-1, $-2);
        auto typeAttr = (TypeAttribute*)$-2.GetAttribute(\qtype\q);
        auto ptrAttr = (PtrAttribute*)$-2.GetAttribute(\qpointer\q);
        auto arrAttr = (ArrAttribute*)$-2.GetAttribute(\qarray\q);
        VarType* varType = new VarType(typeAttr->_typeName, typeAttr->_typeSize, 
        ptrAttr == nullptr ? nullptr : ptrAttr->_ptr, arrAttr == nullptr ? nullptr : arrAttr->_array);
        if (ptrAttr != nullptr) {
            ptrAttr->_ptr = nullptr;
        }
        if (arrAttr != nullptr) {
            arrAttr->_array = nullptr;
        }
        tableManager.AddVar(varType, $-2._value, 
            ((QualifierAttribute*)$-2.GetAttribute(\qqualifier\q))->_isStatic);";

4 QLFR static 
    "reduction_action=
        pinfo.AddAttribute(new QualifierAttribute(\qqualifier\q, true));";

5 QLFR null
    "reduction_action=
        pinfo.AddAttribute(new QualifierAttribute(\qqualifier\q, false));";

6 TYPE int
    "reduction_action=
        CfInfo::MoveAttributes($-2, pinfo);
        auto type = tableManager.GetTable($-1._value);
        if (type == nullptr || type->_type != 1) {
            std::cout << \qtype: \q << $-1._value << \qnot found!\q << std::endl;
        }
        pinfo.AddAttribute(new TypeAttribute(\qtype\q, $-1._value, 4));";

7 TYPE id
    "reduction_action=
        CfInfo::MoveAttributes($-2, pinfo);
        auto type = tableManager.GetTable($-1._value);
        if (type == nullptr || type->_type != 1) {
            std::cout << \qtype: \q << $-1._value << \qnot found!\q << std::endl;
        }
        pinfo.AddAttribute(new TypeAttribute(\qtype\q, $-1._value, 4));";

8 ARR ls num rs 
    "action_2=
        CfInfo::MoveAttributes($-4, $-1);
        auto arrAttr = (ArrAttribute*)$-1.GetAttribute(\qarray\q);
        if (arrAttr == nullptr) {
            arrAttr = new ArrAttribute(\qarray\q);
            $-1.AddAttribute(arrAttr);
        }
        auto typeAttr = (TypeAttribute*)$-1.GetAttribute(\qtype\q);
        int typeSize = typeAttr->_typeSize;
        if ($-1.GetAttribute(\qpointer\q) != nullptr) {
            typeSize = 4;
        }
        arrAttr->AddNestArr(typeSize, std::stoi($-2._value));" 
    ARR 
    "reduction_action=
        CfInfo::MoveAttributes($-1, pinfo);";

9 ARR null
    "reduction_action=
        CfInfo::MoveAttributes($-2, pinfo);";

10 PTR ast 
    "action_3=
        CfInfo::MoveAttributes($-2, $-1);
        auto ptrAttr = (PtrAttribute*)$-2.GetAttribute(\qpointer\q);
        if (ptrAttr == nullptr) {
            ptrAttr = new PtrAttribute(\qpointer\q);
            $-1.AddAttribute(ptrAttr);
        }
        ptrAttr->AddNestPtr();" 
    PTR 
    "reduction_action=
        CfInfo::MoveAttributes($-1, pinfo);";

11 PTR null 
    "reduction_action=
        CfInfo::MoveAttributes($-2, pinfo);";